# React 错误边界

错误边界是一种React组件，这种组件**可以捕获并打印发生在其子组件树任何位置的JavaScript错误，并且，它会渲染出备用UI，而不是那些崩溃了的子组件树**。错误边界在渲染期间、生命周期方法、和整个组件树的构造函数中捕获错误。

> **注意：**错误边界无法捕获以下场景产生的错误：
>
> + 事件处理（[了解更多](https://zh-hans.reactjs.org/docs/error-boundaries.html#how-about-event-handlers))
>
>   在组件中定义的事件处理函数等内部触发的错误
>
> + 异步代码
>
>   `setTimeout` 或 `requestAnimationFrame` 回调函数
>
> + 服务端渲染
>
> + 它自身抛出来的错误（并非它的子组件）

## 定义一个错误边界

当一个**class**组件中定义了**[static getDerivedStateFromError()](https://zh-hans.reactjs.org/docs/react-component.html#static-getderivedstatefromerror)**或**[componentDidCatch()](https://zh-hans.reactjs.org/docs/react-component.html#componentdidcatch)**这两个生命周期方法中的任意一个（或两个）时，那么这个组件就变成了一个错误边界。

> + `static getDerivedStateFromError()`
>
>   该生命周期会在后代组件抛出错误时调用，它将抛出的错误作为参数，并返回一个值以更新state；
>
>   该生命周期会在渲染阶段调用，因此不允许出现副作用。
>
> + `componentDidCatch()`
>
>   该生命周期在后代组件抛出错误时调用，它接受两个参数
>
>   1. error：抛出的错误
>   2. info：带有componentStack key的对象，其中包含[有关组件引发错误的栈信息](https://zh-hans.reactjs.org/docs/error-boundaries.html#component-stack-traces)
>
>   该生命周期会在“提交”阶段被调用，因此允许执行副作用，它应该用于记录错误之类的情况

当错误抛出时，使用前者渲染备用UI，使用后者打印错误信息。

```jsx
class ErrorBoundary extends Component {
    constructor(){
        super();
        this.state = {
            hasError: false
        }
    }
    static getDerivedStateFromError(error){
        // 后代组件抛出错误时调用
        // 更新state使下一次渲染可以显示降级UI
        return {
            hasError: true
        }
    }
    componentDidCatch(error, info){
        // 打印错误信息
    }
    render(){
        if (this.state.hasError){
            // 渲染任何自定义降级UI
            return <h1>An Error Occurred!</h1>
        }
        return this.props.children
    }
}
```

## 参考资料

+ [React 错误边界](https://zh-hans.reactjs.org/docs/error-boundaries.html)

