# Raect 代码分割

## 作用

“懒加载”用户所需要的内容，显著提高应用的性能。

尽管没有减少应用的整体体积，但可以避免加载用户不需要的代码，并在初始加载的时候减少所需加载的代码量。

## 实现

### import()

使用：

```js
// 前
import someModule from "./someModule"
// ...

//后
import("./someModule").then(someModule => {
    // ...
})
```

1. **Create React App**

   开箱即用。

2. **Webpack**

   确保webpack配置文件类似于此：

   ```js
   module.exports = {
     entry: {
       main: './src/app.js',
     },
     output: {
       // `filename` provides a template for naming your bundles (remember to use `[name]`)
       filename: '[name].bundle.js',
       // `chunkFilename` provides a template for naming code-split bundles (optional)
       chunkFilename: '[name].bundle.js',
       // `path` is the folder where Webpack will place your bundles
       path: './dist',
       // `publicPath` is where Webpack will load your bundles from (optional)
       publicPath: 'dist/'
     }
   };
   ```

3. **babel**

   确保 Babel 能够解析动态 import 语法而不是将其进行转换。对于这一要求你需要[@babel/plugin-syntax-dynamic-import](https://classic.yarnpkg.com/en/package/@babel/plugin-syntax-dynamic-import) 插件。

### React.lazy

使用：

```js
// 前
import SomeComponent from "./SomeComponent"

// 后
const SomeComponent = React.lazy(() => import("./SomeComponent"))
```

`React.lazy`函数能够让我们像渲染常规组件一样处理动态引入的组件（不支持服务端渲染）。

它接受一个函数作为参数，该函数需要动态调用import，必须返回一个promise，且该promise需要resolve一个`default export`的React组件。

使用`React.lazy()`引入的组件需要在`Suspense`组件中渲染，同时需要制定一个`fallback`属性用于展示主体组件在加载过程中内容（React元素）。

```jsx
const SomeComponent = React.lazy(() => import("./SomeComponent"))

class OtherComponent extends Component {
    render(){
        return (
        	<Suspense fallback={<div>Loading...</div>}>
	      		<SomeComponent></SomeComponent>
			</Suspense>
        )
    }
}
```

也可以用`Suspense`组件包裹多个懒加载组件。

```jsx
const OtherComponent = React.lazy(() => import("./OtherComponent"))
const AnotherComponent = React.lazy(() => import("./AnotherComponent"))

class MyComponent extends Component {
    render(){
        return (
        	<Suspense fallback={<div>Loading...</div>}>
            	<OtherComponent></OtherComponent>
                <AnotherComponent></AnotherComponent>
            </Suspense>
        )
    }
}
```

#### 命名导出

`React.lazy`只支持默认导出，如果被引入的模块内使用的是命名导出，则我们可以创建一个中间模块，来重新导出为默认模块：

```jsx
// someComponents.js
export const OneComponent = /* ... */;
export const AnotherComponent = /* ... */;

// OneComponent.js
export { OneComponent as default } from "./someComponents.js";

// App.js
const OneComponent = React.lazy(() => import("./OneComponent.js"));
```

## 参考资料

+ [React 代码分割](https://zh-hans.reactjs.org/docs/code-splitting.html)