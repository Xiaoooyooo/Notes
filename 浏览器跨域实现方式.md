# 浏览器跨域实现方式

 同源策略是由Netscape提出的著名安全策略，是浏览器最核心、基本的安全功能,它限制了一个源(origin)中加载文本或者脚本与来自其他源(origin)中资源的交互方式，所谓的同源就是指协议、域名、端口相同。当浏览器执行一个脚本时会检查是否同源，只有同源的脚本才会执行，如果不同源即为跨域。

## 实现跨域的几种方式

+ jsonp
+ CORS

### jsonp跨域

所谓jsonp实质上就是**利用script标签不受同源策略的限制的特点，后端将数据以JavaScript文件的形式响应给前端**。响应内容是一个函数，该函数由前端定义。实现方式如下：

```js
//前端代码
let script = document.createElement('script')
script.src = "http://127.0.0.1:8888?callback=_callback"	//请求链接中放入回调函数名，并在全局环境中定义该函数
document.body.appendChild(script)	//一旦script标签插入到文档中，其中的js代码就会立即被解析执行

function _callback(res){	//定义函数
    console.log(res)
}


//后端代码	Nodejs(koa)
app.use(async (ctx,next)=>{
    ctx.set("Content-Type","text/javascript")
    let callbackName = ctx.query.callback
    let msg = {	//需要的数据
        status:"OK",
        message:"Hello World!"
    }
    ctx.body = `${callbackName}(${JSON.stringify(msg)})`	//将数据放入callback函数的参数中
})
```

控制台输出内容：

> {status: "OK", message: "Hello World!"}

### CORS

 Cross-Origin Resource Sharing(跨域资源共享)是一种允许当前域（origin）的资源（比如html/js/web service）被其他域（origin）的脚本请求访问的机制。当使用XMLHttpRequest发送请求时，**浏览器如果发现违反了同源策略就会自动加上一个请求头:origin**,后端在接受到请求后确定响应后会在Response Headers中加入一个属性:`Access-Control-Allow-Origin`,值就是发起请求的源地址`http://127.0.0.1:8888`，浏览器得到响应会进行判断`Access-Control-Allow-Origin`的值是否和当前的地址相同，只有匹配成功后才进行响应处理。

由此可见，**CORS 需要浏览器和后端同时支持**。

```js
//前端代码
let xhr = new XMLHttpRequest
xhr.open("get","http://127.0.0.1:8888")
xhr.onload = function(){
    console.log(this.response)
}
xhr.send()



//后端代码	Nodejs(koa)
app.use(async (ctx,next)=>{
    //ctx.set("Access-Control-Allow-Origin":"*")
    ctx.set('Content-Type','application/json')
    let msg =  {	//需要的数据
        status:"OK",
        message:"Hello World!"
    }
    ctx.body = msg
})
```

上面的后端代码中注释了`ctx.set("Access-Control-Allow-Origin":"*")`一行，此时前端的请求会相应如下内容：

> 首先一条报错信息：
> Access to XMLHttpRequest at 'http://127.0.0.1:8888/' from origin 'null' has been blocked by > CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
>
> 
>
> 其次一条来自浏览器的警告信息：
> Cross-Origin Read Blocking (CORB) blocked cross-origin response http://127.0.0.1:8888/ with MIME type application/json. See https://www.chromestatus.com/feature/5629709824032768 for more details.

如果取消后端代码中的那条注释，则会成功请求，控制台输出：

> {"status":"OK","message":"Hello World!"}






